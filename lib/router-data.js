import axios from"axios";let getToken="",url="";const urldev="http://authorityapi.test.xq5.com",urlProd="https://authorityapi.xq5.com";let routerMaps=[],originalData=[],menuList=[],controlDataTagList={};const service=axios.create({headers:{}});function routerData({token:n,platform_key:a,routerUrl:o,sub_id:i=0,dataType:u=1,env:s="dev",env_id:l="1"}){return new Promise((t,e)=>{0===(getToken=n?n:getToken).length&&t({errno:1,errmsg:"token参数错误"});var r={dev:urldev,prod:urlProd};url=url&&0!==url.length?url:r[s],routerMaps=o,getMenuDataAndTag({platform_key:a,sub_id:i,env_id:Number(l)}).then(e=>{menuList=e.menuData,controlDataTagList=e.tagData,console.log("menu and control",controlDataTagList,menuList);e={1:menuList,2:controlDataTagList,3:originalData,4:{menuList:menuList,controlDataTagList:controlDataTagList}};t(e[Number(u)]||e[4])}).catch(e=>{t(e)})})}function containsNumber(t){for(let e=0;e<10;e++)if(-1!==t.indexOf(e))return!0;return!1}service.interceptors.response.use(e=>{return e.data},async e=>{const t={errno:-1,errmsg:""};return e.response?401===e.response.status?t.errmsg="登录信息过期，跳转登录页401":t.errmsg="错误状态码："+e.response.status:t.errmsg=e.config.url+"响应失败，请刷新浏览器重试。原因"+e,Promise.reject(t)});let pathOld="",controlData={};function controlFindData({path:e="",permissionId:t="",isBool:r=!0}){const n=window.location.hash.replace(/#/g,""),a=(e=0===e.length?0<n.indexOf("?")?n.substring(0,n.indexOf("?")):n||window.location.pathname:e,new RegExp(/^(\-|\+)?\d+(\.\d+)?$/));if(containsNumber(e)){const i=e.split("/"),u=i.filter(e=>e&&!a.test(e));e=u?"/"+u.join("/"):e}var o;return pathOld!==e&&(o=controlDataTagList[e]||[],controlData=onControlFindDataObj(o),pathOld=e),0!==t.length?(o=controlData[t]||{},5!==Number(o.type)&&6!==Number(o.type)&&r?0!==Object.keys(o).length:o):controlData}function onControlFindDataObj(e,t={}){return e.forEach(e=>{e.permission_id&&(t[e.permission_id]=e).children&&0!==e.children.length&&onControlFindDataObj(e.children,t)}),t}function onControlFindData(e,t,r=[]){return e.forEach(e=>{e.permission_id===t?r.push(e):e.children&&0!==e.children.length&&onControlFindData(e.children,t,r)}),r}const getMenuDataAndTag=e=>new Promise((n,a)=>{service.defaults.headers.common["x-xq5-jwt"]=getToken,service.get(url+"/v1/web/menu",{params:e}).then(e=>{var t,r;e&&e.data&&0===Number(e.errno)?(t=generateAsyncRouter(originalData=e.data||[],1),r=generateAsyncRouter(originalData,2),n({menuData:t,tagData:r})):(console.log(123,e),a({errno:e.errno||1,errmsg:e.errmsg||"error1"}))}).catch(e=>{a(e)})});function generateAsyncRouter(e,a=1,o=!1){const i=[];switch(a){case 1:case"1":return e.forEach(e=>{if((1===Number(e.type)||2===Number(e.type))&&1===Number(e.status)){var t=e.children&&0<e.children.length,r=t&&e.children&&0!==e.children.filter(e=>2===e.type).length;const n=generateRouter(e,!o||r,o);r?n.children=generateAsyncRouter(e.children,a,!0)||[]:o||(n.children=[generateRouter(e,!!t&&(e.children&&0!==e.children.filter(e=>2===e.type).length),o)]),i.push(n)}}),i;case 2:case"2":return generateControlAndDataTag(e);default:return[]}}const generateRouter=(e,t,r)=>({path:e.is_out_link?e.route_data:t||!r?0===e.route_data.indexOf("/")?e.route_data:"/"+e.route_data:e.route_data||"",name:e.is_out_link?e.route_data:t?e.route_data+"p":e.route_data||"",alwaysShow:!1,meta:{title:e.name,icon:e.icon,id:e.menu_id,newTime:e.showtime?dateAndTimestampConversion(e.showtime):"",noCache:!1},component:e.is_out_link?e.route_data:t&&!r?routerMaps.Layout:routerMaps[0===e.route_data.indexOf("/")?e.route_data.slice(1,e.route_data.length):e.route_data]||""}),generateControlAndDataTag=(a,o="",i={})=>(a.forEach(e=>{var t,r=e.children&&0<e.children.length,n=o;1!==Number(e.type)&&2!==Number(e.type)&&1===Number(e.status)?(t=dataControlAndDataTag(a),i[o]=t):1!==Number(e.type)&&2!==Number(e.type)||1!==Number(e.status)||(n+=e.is_out_link||0===e.route_data.indexOf("/")?e.route_data:"/"+e.route_data,r&&generateControlAndDataTag(e.children,n,i))}),i);function dataControlAndDataTag(e){const r=[];return e.forEach(e=>{let t={};3===Number(e.type)||4===Number(e.type)?t={name:e.name,icon:e.icon,type:e.type,permission_id:e.route_data}:5!==Number(e.type)&&6!==Number(e.type)||(t={name:e.name,backend_api:e.backend_api,type:e.type,data_labels:e.data_labels,backend_api_method:e.backend_api_method,permission_id:e.route_data,show_prop:e.fields}),e.children&&(t.children=dataControlAndDataTag(e.children)),r.push(t)}),r}function getSubPlatformData({token:n,platform_key:a="",env:o="dev",env_id:i="1"}){return new Promise((t,e)=>{0===(getToken=n?n:getToken).length&&t({errno:1,errmsg:"token参数错误"});var r={dev:urldev,prod:urlProd};url=url&&0!==url.length?url:r[o],service.defaults.headers.common["x-xq5-jwt"]=getToken,service.get(url+"/v1/web/sub_platform",{params:{platform_key:a,env_id:Number(i)}}).then(e=>{e&&e.data&&0===Number(e.errno)?t(e.data):t({errno:e.errno||1,errmsg:e.errmsg||"error2"})}).catch(e=>{t(e)})})}function dateAndTimestampConversion(e,t=!0){var r=Object.prototype.toString.call(e);if("[object Number]"!==r&&"[object String]"!==r)throw new Error("参数应为数字或字符串类型");var r="[object Number]"===r;if(r&&10!==String(e).length&&13!==String(e).length)throw new Error("时间戳位数应为10位数或13位数");if(!r&&10!==e.length&&19!==e.length)throw new Error("日期位数应为10位数或19位数");if(String(e).includes("-")||String(e).includes("/"))return r=e.replace(/-/g,"/"),new Date(r).getTime();{const u=new Date(10===String(e).length?1e3*Number(e):Number(e));var r=u.getFullYear(),e=(u.getMonth()+1).toString().padStart(2,"0"),n=u.getDate().toString().padStart(2,"0"),a=u.getHours().toString().padStart(2,"0"),o=u.getMinutes().toString().padStart(2,"0"),i=u.getSeconds().toString().padStart(2,"0");return t?r+`-${e}-`+n:r+`-${e}-${n} ${a}:${o}:`+i}}export{menuList,routerData,controlFindData,getSubPlatformData};