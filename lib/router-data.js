import axios from"axios";let getToken="",url="";const urldev="http://10.0.10.213:8200",urlProd="http://10.0.10.213:8200",urlProdNew="http://10.0.10.213:8200",urlProdSW="http://10.0.10.213:8200";let routerMaps=[],originalData=[],menuList=[],controlDataTagList={};function routerData({token:r,platform_key:n,routerUrl:o,dataType:i=1,env:u="dev"}){return new Promise((e,t)=>{r?getToken=r:e({errno:1,errmsg:"token参数错误"});var a={dev:urldev,prod:urlProd,prodNew:urlProdNew,prodSW:urlProdSW};url=a[u],routerMaps=o,getMenuDataAndTag({platform_key:n}).then(t=>{menuList=t.menuData,controlDataTagList=t.tagData,console.log("menu and control",controlDataTagList,menuList);t={1:menuList,2:controlDataTagList,3:originalData,4:{menuList:menuList,controlDataTagList:controlDataTagList}};e(t[Number(i)]||t[4])}).catch(t=>{e(t)})})}function controlFindData({path:t="",permissionId:e="",isBool:a=!0}){t=0===t.length?window.location.hash.replace(/#/g,"")||window.location.pathname:t,console.log("path",t);var r,t=controlDataTagList[t]||[];return 0!==e.length?(e=onControlFindData(t,e),console.log("Find Data",e),r=0!==e.length?e[0]:{},5!==Number(r.type)&&6!==Number(r.type)&&a?0!==e.length:r):t}function onControlFindData(t,e,a=[]){return t.forEach(t=>{t.permission_id===e?a.push(t):t.children&&0!==t.children.length&&onControlFindData(t.children,e,a)}),a}axios.interceptors.response.use(t=>{return t.data},async t=>{const e={errno:-1,errmsg:""};return t.response?401===t.response.status?e.errmsg="登录信息过期，跳转登录页401":e.errmsg="错误状态码："+t.response.status:e.errmsg=t.config.url+"响应失败，请刷新浏览器重试。原因"+t,Promise.reject(e)});const getMenuDataAndTag=t=>new Promise((a,e)=>{axios.defaults.headers.common["x-xq5-jwt"]=getToken,axios.get(url+"/v1/web/menu",{params:t}).then(t=>{var e;t&&t.data&&0===Number(t.errno)&&(t=generateAsyncRouter(originalData=t.data||[],1),e=generateAsyncRouter(originalData,2),a({menuData:t,tagData:e}))}).catch(t=>{e(t)})});function generateAsyncRouter(t,n=1,o=!1){const i=[];switch(n){case 1:case"1":return t.forEach(t=>{if((1===Number(t.type)||2===Number(t.type))&&1===Number(t.status)){var e=t.children&&0<t.children.length,a=e&&t.children&&0!==t.children.filter(t=>2===t.type).length;const r=generateRouter(t,!o||a,o);a?r.children=generateAsyncRouter(t.children,n,!0)||[]:o||(r.children=[generateRouter(t,!!e&&(t.children&&0!==t.children.filter(t=>2===t.type).length),o)]),i.push(r)}}),i;case 2:case"2":return generateControlAndDataTag(t);default:return[]}}const generateRouter=(t,e,a)=>({path:t.is_out_link?t.route_data:e||!a?0===t.route_data.indexOf("/")?t.route_data:"/"+t.route_data:t.route_data||"",name:t.is_out_link?t.route_data:e?t.route_data+"p":t.route_data||"",alwaysShow:!1,meta:{title:t.name,icon:t.icon,id:t.menu_id,newTime:t.showtime?dateAndTimestampConversion(t.showtime):"",noCache:!1},component:t.is_out_link?t.route_data:e&&!a?routerMaps.Layout:routerMaps[0===t.route_data.indexOf("/")?t.route_data.slice(1,t.route_data.length):t.route_data]||""}),generateControlAndDataTag=(n,o="",i={})=>(n.forEach(t=>{var e,a=t.children&&0<t.children.length,r=o;1!==Number(t.type)&&2!==Number(t.type)&&1===Number(t.status)?(e=dataControlAndDataTag(n),i[o]=e):1!==Number(t.type)&&2!==Number(t.type)||1!==Number(t.status)||(r+=t.is_out_link||0===t.route_data.indexOf("/")?t.route_data:"/"+t.route_data,a&&generateControlAndDataTag(t.children,r,i))}),i);function dataControlAndDataTag(t){const a=[];return t.forEach(t=>{let e={};3===Number(t.type)||4===Number(t.type)?e={name:t.name,icon:t.icon,type:t.type,permission_id:t.route_data}:5!==Number(t.type)&&6!==Number(t.type)||(e={name:t.name,backend_api:t.backend_api,type:t.type,data_labels:t.data_labels,backend_api_method:t.backend_api_method,permission_id:t.route_data,show_prop:t.fields}),t.children&&(e.children=dataControlAndDataTag(t.children)),a.push(e)}),a}const getSubPlatformData=t=>{axios.defaults.headers.common["x-xq5-jwt"]=getToken,axios.get(url+"/v1/web/sub_platform",{params:t}).then(t=>{t&&t.data&&0===Number(t.errno)&&(console.log(2222,t),t=generateAsyncRouter(originalData=t.data||[]),console.log(111,t))})};function dateAndTimestampConversion(t,e=!0){var a=Object.prototype.toString.call(t);if("[object Number]"!==a&&"[object String]"!==a)throw new Error("参数应为数字或字符串类型");var a="[object Number]"===a;if(a&&10!==String(t).length&&13!==String(t).length)throw new Error("时间戳位数应为10位数或13位数");if(!a&&10!==t.length&&19!==t.length)throw new Error("日期位数应为10位数或19位数");if(String(t).includes("-")||String(t).includes("/"))return a=t.replace(/-/g,"/"),new Date(a).getTime();{const u=new Date(10===String(t).length?1e3*Number(t):Number(t));var a=u.getFullYear(),t=(u.getMonth()+1).toString().padStart(2,"0"),r=u.getDate().toString().padStart(2,"0"),n=u.getHours().toString().padStart(2,"0"),o=u.getMinutes().toString().padStart(2,"0"),i=u.getSeconds().toString().padStart(2,"0");return e?a+`-${t}-`+r:a+`-${t}-${r} ${n}:${o}:`+i}}export{routerData,controlFindData};