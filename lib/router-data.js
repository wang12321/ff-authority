import axios from"axios";let getToken="",url="";const urldev="http://10.0.10.213:8200",urlProd="http://10.0.10.213:8200",urlProdNew="http://10.0.10.213:8200",urlProdSW="http://10.0.10.213:8200";let routerMaps=[],originalData=[],menuList=[],controlDataTagList={};function routerData({token:a,platform_key:n,routerUrl:o,sub_id:i=0,dataType:u=1,env:s="dev"}){return new Promise((e,t)=>{0===(getToken=a?a:getToken).length&&e({errno:1,errmsg:"token参数错误"});var r={dev:urldev,prod:urlProd,prodNew:urlProdNew,prodSW:urlProdSW};url=r[s],routerMaps=o,getMenuDataAndTag({platform_key:n,sub_id:i}).then(t=>{menuList=t.menuData,controlDataTagList=t.tagData,console.log("menu and control",controlDataTagList,menuList);t={1:menuList,2:controlDataTagList,3:originalData,4:{menuList:menuList,controlDataTagList:controlDataTagList}};e(t[Number(u)]||t[4])}).catch(t=>{e(t)})})}function containsNumber(e){for(let t=0;t<10;t++)if(-1!==e.indexOf(t))return!0;return!1}axios.interceptors.response.use(t=>{return t.data},async t=>{const e={errno:-1,errmsg:""};return t.response?401===t.response.status?e.errmsg="登录信息过期，跳转登录页401":e.errmsg="错误状态码："+t.response.status:e.errmsg=t.config.url+"响应失败，请刷新浏览器重试。原因"+t,Promise.reject(e)});let pathOld="",controlData={};function controlFindData({path:t="",permissionId:e="",isBool:r=!0}){const a=window.location.hash.replace(/#/g,""),n=(t=0===t.length?0<a.indexOf("?")?a.substring(0,a.indexOf("?")):a||window.location.pathname:t,new RegExp(/^(\-|\+)?\d+(\.\d+)?$/));if(containsNumber(t)){const i=t.split("/"),u=i.filter(t=>t&&!n.test(t));t=u?"/"+u.join("/"):t}var o;return pathOld!==t&&(o=controlDataTagList[t]||[],controlData=onControlFindDataObj(o),pathOld=t),0!==e.length?(o=controlData[e]||{},5!==Number(o.type)&&6!==Number(o.type)&&r?0!==Object.keys(o).length:o):controlData}function onControlFindDataObj(t,e={}){return t.forEach(t=>{t.permission_id&&(e[t.permission_id]=t).children&&0!==t.children.length&&onControlFindDataObj(t.children,e)}),e}function onControlFindData(t,e,r=[]){return t.forEach(t=>{t.permission_id===e?r.push(t):t.children&&0!==t.children.length&&onControlFindData(t.children,e,r)}),r}const getMenuDataAndTag=t=>new Promise((a,n)=>{axios.defaults.headers.common["x-xq5-jwt"]=getToken,axios.get(url+"/v1/web/menu",{params:t}).then(t=>{var e,r;t&&t.data&&0===Number(t.errno)?(e=generateAsyncRouter(originalData=t.data||[],1),r=generateAsyncRouter(originalData,2),a({menuData:e,tagData:r})):n({errno:t.errno||1,errmsg:t.errmsg||"error"})}).catch(t=>{n(t)})});function generateAsyncRouter(t,n=1,o=!1){const i=[];switch(n){case 1:case"1":return t.forEach(t=>{if((1===Number(t.type)||2===Number(t.type))&&1===Number(t.status)){var e=t.children&&0<t.children.length,r=e&&t.children&&0!==t.children.filter(t=>2===t.type).length;const a=generateRouter(t,!o||r,o);r?a.children=generateAsyncRouter(t.children,n,!0)||[]:o||(a.children=[generateRouter(t,!!e&&(t.children&&0!==t.children.filter(t=>2===t.type).length),o)]),i.push(a)}}),i;case 2:case"2":return generateControlAndDataTag(t);default:return[]}}const generateRouter=(t,e,r)=>({path:t.is_out_link?t.route_data:e||!r?0===t.route_data.indexOf("/")?t.route_data:"/"+t.route_data:t.route_data||"",name:t.is_out_link?t.route_data:e?t.route_data+"p":t.route_data||"",alwaysShow:!1,meta:{title:t.name,icon:t.icon,id:t.menu_id,newTime:t.showtime?dateAndTimestampConversion(t.showtime):"",noCache:!1},component:t.is_out_link?t.route_data:e&&!r?routerMaps.Layout:routerMaps[0===t.route_data.indexOf("/")?t.route_data.slice(1,t.route_data.length):t.route_data]||""}),generateControlAndDataTag=(n,o="",i={})=>(n.forEach(t=>{var e,r=t.children&&0<t.children.length,a=o;1!==Number(t.type)&&2!==Number(t.type)&&1===Number(t.status)?(e=dataControlAndDataTag(n),i[o]=e):1!==Number(t.type)&&2!==Number(t.type)||1!==Number(t.status)||(a+=t.is_out_link||0===t.route_data.indexOf("/")?t.route_data:"/"+t.route_data,r&&generateControlAndDataTag(t.children,a,i))}),i);function dataControlAndDataTag(t){const r=[];return t.forEach(t=>{let e={};3===Number(t.type)||4===Number(t.type)?e={name:t.name,icon:t.icon,type:t.type,permission_id:t.route_data}:5!==Number(t.type)&&6!==Number(t.type)||(e={name:t.name,backend_api:t.backend_api,type:t.type,data_labels:t.data_labels,backend_api_method:t.backend_api_method,permission_id:t.route_data,show_prop:t.fields}),t.children&&(e.children=dataControlAndDataTag(t.children)),r.push(e)}),r}function getSubPlatformData({token:r,platform_key:a=""}){return new Promise((e,t)=>{0===(getToken=r?r:getToken).length&&e({errno:1,errmsg:"token参数错误"}),axios.defaults.headers.common["x-xq5-jwt"]=getToken,axios.get(url+"/v1/web/sub_platform",{params:{platform_key:a}}).then(t=>{t&&t.data&&0===Number(t.errno)?e(t.data):e({errno:t.errno||1,errmsg:t.errmsg||"error"})}).catch(t=>{e(t)})})}function dateAndTimestampConversion(t,e=!0){var r=Object.prototype.toString.call(t);if("[object Number]"!==r&&"[object String]"!==r)throw new Error("参数应为数字或字符串类型");var r="[object Number]"===r;if(r&&10!==String(t).length&&13!==String(t).length)throw new Error("时间戳位数应为10位数或13位数");if(!r&&10!==t.length&&19!==t.length)throw new Error("日期位数应为10位数或19位数");if(String(t).includes("-")||String(t).includes("/"))return r=t.replace(/-/g,"/"),new Date(r).getTime();{const u=new Date(10===String(t).length?1e3*Number(t):Number(t));var r=u.getFullYear(),t=(u.getMonth()+1).toString().padStart(2,"0"),a=u.getDate().toString().padStart(2,"0"),n=u.getHours().toString().padStart(2,"0"),o=u.getMinutes().toString().padStart(2,"0"),i=u.getSeconds().toString().padStart(2,"0");return e?r+`-${t}-`+a:r+`-${t}-${a} ${n}:${o}:`+i}}export{menuList,routerData,controlFindData,getSubPlatformData};